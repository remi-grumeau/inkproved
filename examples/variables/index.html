<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Inkproved - Variables</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../ink/css/inkproved.css">
</head>

<body>

    <div id="ink__container">
        <div id="ink__story"></div>
    </div>


    <div style="display:flex;flex-direction:column;align-items:center;gap:1em;padding-top:1em;border-top:1px solid #aaa">
        <button onclick="logVariable('_whereAmI')">Get _WhereAmI variable value</button>
        <button onclick="logVariable('_temperature')">Get _temperature variable value</button>
        <button onclick="_INK.setVariable('_temperature',18)">Set _temperature variable to 18°</button>

        <div id="log"></div>
    </div>



    <script src="../../ink/scripts/ink.js"></script>
    <script src="../../ink/scripts/inkproved.js"></script>
    <script src="mystory.js"></script>

    <script>
    // FIRST LOAD STORY WITH AUTOSTART TO FALSE
    _INK.loadStory(storyContent,false);



    // SET LISTENERS ON VARIABLES
    _INK.listenVariable('_whereAmI',function(varName, newValue){
        document.getElementById('log').innerHTML += '<p>WhereAmI variable got updated in Ink to : '+newValue+'</p>';
    });

    function logVariable(variableName){
        document.getElementById('log').innerHTML += '<p>'+variableName+' variable value is : '+_INK.getVariable(variableName)+'</p>';
    }



    // SET VARIABLES IN INK

    // FIRST, SET THE CURRENT DAY
    let _daysName = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
    let _dayName  = _daysName[new Date().getDay()];
    _INK.setVariable("_day", _dayName );


    // SECOND SET THE DAY TIME BASED ON THE ACTUAL HOUR
    let _daytime,_hour = new Date().getHours();
    if(_hour<=6 || _hour>=20)
        _daytime = 'night';
    else if(_hour<12)
        _daytime = 'morning';
    else if(_hour<14)
        _daytime = 'noon';
    else if(_hour<20)
        _daytime = 'afternoon';

    _INK.setVariable("_daytime",_daytime);


    // LAST GET THE REAL TEMPERATURE FOR A GIVEN POSITION (HERE WINDSOR CASTLE IN THE UK)
    // SINCE FETCH IS ASYNCRONOUS, CALL IS NOT BLOCKING THE REST BUT RETURN COMES A FEW MILLISECONDS LATER
    // SO WE USE _INK.setVariable TO SET THE VARIABLE WHEN FETCH GETS ITS CALLBACK
    const _lat = 51.4839874;
    const _lng = -0.6062766;
    fetch('https://api.open-meteo.com/v1/forecast?latitude='+_lat+'&longitude='+_lng+'&current=temperature')
    .then(response => response.json())
    .then(response => {
        _INK.setVariable('_temperature',response.current.temperature);

        // START INK STORY ONLY WHEN THE SERVER GAVE THE TEMPERATURE BACK
        _INK.start();
    })
    .catch(error => {
        alert("Online weather api error : " + error + " (offline ?)");

        // START INK STORY ANYWAY, KEEPING THE 0 DEFAULT VALUE AS A TEMPERATURE
        _INK.start();
    });


    </script>


</body>
</html>
